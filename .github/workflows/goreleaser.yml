name: goreleaser

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "latest"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      - name: Trigger docs version branch
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
          repository: kubestellar/docs
          event-type: create-version-branch
          client-payload: |
            {
              "project": "klaude",
              "version": "${{ github.ref_name }}",
              "source_repo": "kubestellar/klaude",
              "source_branch": "${{ github.ref_name }}"
            }
      - name: Trigger marketplace plugin update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
          repository: kubestellar/claude-plugins
          event-type: update-plugin-version
          client-payload: |
            {
              "version": "${{ github.ref_name }}",
              "source_repo": "kubestellar/klaude"
            }
